package com.liferay.security

import org.json.JSONObject
import spock.lang.Specification

class RescannerSpec extends Specification {

	def "associateKnownVulnerabilitiesWithTargets"() {
		setup:
		def rescanner = new Rescanner()

		def jsonObjectString = '''{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","self":"https://issues-uat.liferay.com/rest/api/2/issue/417610","id":"417610","fields":{"customfield_19321":null,"issuetype":{"avatarId":18643,"name":"Bug","self":"https://issues-uat.liferay.com/rest/api/2/issuetype/1","description":"A problem which impairs or prevents the functions of the product.","id":"1","iconUrl":"https://issues-uat.liferay.com/secure/viewavatar?size=xsmall&avatarId=18643&avatarType=issuetype","subtask":false},"customfield_19322":null,"customfield_19323":"Please list the following here in the Campaign Details:\\r\\n* Enrollment criteria\\r\\n* Workflow Goal\\r\\n* Workflow Special Instructions\\r\\n* Link to Workflows","customfield_10190":null,"customfield_10191":null,"customfield_10193":null,"timespent":null,"customfield_10194":null,"customfield_19320":null,"customfield_10195":null,"customfield_15720":"2|i05paf:","project":{"avatarUrls":{"48x48":"https://issues-uat.liferay.com/secure/projectavatar?pid=16581&avatarId=23960","24x24":"https://issues-uat.liferay.com/secure/projectavatar?size=small&pid=16581&avatarId=23960","16x16":"https://issues-uat.liferay.com/secure/projectavatar?size=xsmall&pid=16581&avatarId=23960","32x32":"https://issues-uat.liferay.com/secure/projectavatar?size=medium&pid=16581&avatarId=23960"},"projectCategory":{"name":"c) Internal","self":"https://issues-uat.liferay.com/rest/api/2/projectCategory/10002","description":"Internal Projects that are only accessible to Liferay Staff","id":"10002"},"name":"INTERNAL - Liferay Information Security","self":"https://issues-uat.liferay.com/rest/api/2/project/16581","id":"16581","key":"LRINFOSEC"},"fixVersions":[],"customfield_10111":null,"aggregatetimespent":null,"resolution":null,"customfield_19722":null,"customfield_19723":null,"customfield_19724":null,"customfield_10821":"9223372036854775807","customfield_16528":null,"resolutiondate":null,"workratio":-1,"lastViewed":null,"watches":{"self":"https://issues-uat.liferay.com/rest/api/2/issue/LRINFOSEC-172/watchers","isWatching":false,"watchCount":0},"customfield_18020":null,"created":"2017-09-12T01:02:20.000+0000","customfield_10220":"9223372036854775807","priority":{"name":"Minor","self":"https://issues-uat.liferay.com/rest/api/2/priority/4","iconUrl":"https://issues-uat.liferay.com/images/icons/priorities/minor.svg","id":"4"},"customfield_16527":null,"customfield_10421":null,"customfield_12523":null,"labels":["host-vulnerability:cloud-10-1-0-13;LSV-278","host-vulnerability:cloud-10-1-0-13;LSV-322","host-vulnerability:cloud-10-50-0-230;LSV-322","host:cloud-10-1-0-13","host:cloud-10-50-0-230","scanID:20170810150252","tool-version:liferay-vulnerability-scanner-0.0.1","tool:liferay-vulnerability-scanner","type:generated","vulnerability:LSV-278","vulnerability:LSV-322"],"customfield_12720":null,"customfield_11625":"For Scripts Only","aggregatetimeoriginalestimate":null,"timeestimate":null,"versions":[],"issuelinks":[],"assignee":{"avatarUrls":{"48x48":"https://issues-uat.liferay.com/secure/useravatar?ownerId=eddie.olson&avatarId=18048","24x24":"https://issues-uat.liferay.com/secure/useravatar?size=small&ownerId=eddie.olson&avatarId=18048","16x16":"https://issues-uat.liferay.com/secure/useravatar?size=xsmall&ownerId=eddie.olson&avatarId=18048","32x32":"https://issues-uat.liferay.com/secure/useravatar?size=medium&ownerId=eddie.olson&avatarId=18048"},"displayName":"Eddie Olson","name":"eddie.olson","self":"https://issues-uat.liferay.com/rest/api/2/user?username=eddie.olson","active":true,"timeZone":"America/Los_Angeles","key":"eddie.olson"},"updated":"2017-10-05T21:19:45.000+0000","status":{"name":"Backlog","self":"https://issues-uat.liferay.com/rest/api/2/status/10021","description":"","iconUrl":"https://issues-uat.liferay.com/images/icons/subtask.gif","id":"10021","statusCategory":{"colorName":"blue-gray","name":"To Do","self":"https://issues-uat.liferay.com/rest/api/2/statuscategory/2","id":2,"key":"new"}},"customfield_19222":null,"customfield_19420":null,"customfield_19223":null,"components":[{"name":"Blue Team","self":"https://issues-uat.liferay.com/rest/api/2/component/26601","id":"26601"}],"customfield_19224":{"self":"https://issues-uat.liferay.com/rest/api/2/customFieldOption/20240","id":"20240","value":"Low"},"customfield_19422":null,"customfield_19620":null,"customfield_19423":null,"customfield_10051":null,"customfield_19221":{"self":"https://issues-uat.liferay.com/rest/api/2/customFieldOption/20235","id":"20235","value":"RFP"},"timeoriginalestimate":null,"description":"testdescription","customfield_19627":["a","b","c"],"customfield_17720":null,"customfield_19424":null,"customfield_19623":"*Precondition:*\\r\\n\\r\\n*Minimal guarantees:*\\r\\n\\r\\n*Success guarantees:*\\r\\n\\r\\n*Main success scenario steps:*\\r\\n# First Step\\r\\n#* Extension\\r\\n#** Sub-Extension\\r\\n# \\r\\n\\r\\n*Variations:*\\r\\n\\r\\n*Related Information:*","timetracking":{},"customfield_11225":null,"customfield_12821":null,"security":{"name":"InfoSec Secure","self":"https://issues-uat.liferay.com/rest/api/2/securitylevel/13530","description":"Visible to members of the Information Security team and participants of the issue","id":"13530"},"attachment":[],"aggregatetimeestimate":null,"summary":"testsummary","creator":{"avatarUrls":{"48x48":"https://issues-uat.liferay.com/secure/useravatar?ownerId=eddie.olson&avatarId=18048","24x24":"https://issues-uat.liferay.com/secure/useravatar?size=small&ownerId=eddie.olson&avatarId=18048","16x16":"https://issues-uat.liferay.com/secure/useravatar?size=xsmall&ownerId=eddie.olson&avatarId=18048","32x32":"https://issues-uat.liferay.com/secure/useravatar?size=medium&ownerId=eddie.olson&avatarId=18048"},"displayName":"Eddie Olson","name":"eddie.olson","self":"https://issues-uat.liferay.com/rest/api/2/user?username=eddie.olson","active":true,"timeZone":"America/Los_Angeles","key":"eddie.olson"},"subtasks":[],"customfield_12020":["eddie.olson(eddie.olson)"],"reporter":{"avatarUrls":{"48x48":"https://issues-uat.liferay.com/secure/useravatar?ownerId=eddie.olson&avatarId=18048","24x24":"https://issues-uat.liferay.com/secure/useravatar?size=small&ownerId=eddie.olson&avatarId=18048","16x16":"https://issues-uat.liferay.com/secure/useravatar?size=xsmall&ownerId=eddie.olson&avatarId=18048","32x32":"https://issues-uat.liferay.com/secure/useravatar?size=medium&ownerId=eddie.olson&avatarId=18048"},"displayName":"Eddie Olson","name":"eddie.olson","self":"https://issues-uat.liferay.com/rest/api/2/user?username=eddie.olson","active":true,"timeZone":"America/Los_Angeles","key":"eddie.olson"},"aggregateprogress":{"total":0,"progress":0},"customfield_11531":null,"customfield_12820":null,"environment":null,"customfield_13627":null,"duedate":null,"progress":{"total":0,"progress":0},"comment":{"total":0,"comments":[],"maxResults":0,"startAt":0},"votes":{"hasVoted":false,"self":"https://issues-uat.liferay.com/rest/api/2/issue/LRINFOSEC-172/votes","votes":0},"worklog":{"total":0,"maxResults":20,"startAt":0,"worklogs":[]}},"key":"LRINFOSEC-172"}'''

		when:
		def hostsVulnerabilities = rescanner.processJiraIssueJSONObject(new JSONObject(jsonObjectString))

		then:
		hostsVulnerabilities == [
			"cloud-10-1-0-13":
				["LSV-278", "LSV-322"],
			"cloud-10-50-0-230":
				["LSV-322"]]
	}

}