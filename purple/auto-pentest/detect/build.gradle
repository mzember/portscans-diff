task owners {
	ext.outputFilePath = "$buildDir/$name"
	doLast {
		file(outputFilePath).text = ""
	}
	doLast {
		def hostVulnerabilities = new HashMap<String, List<String>>()

		def vulnerabilityFiles = fileTree(dir: "vulnerabilities/build").files

		for (vulnerabilityFile in vulnerabilityFiles) {
			def matcher = (vulnerabilityFile.name =~ /^(.*)_[a-z]+_(.*)/)

			def host = matcher[0][1]

			def vulnerability = matcher[0][2]

			if (!hostVulnerabilities.containsKey(host)) {
				hostVulnerabilities.put(host, [vulnerability])
			}
			else {
				def vulnerabilities = hostVulnerabilities.get(host)

				vulnerabilities.add(vulnerability)
			}
		}

		def hostHostnames = new HashMap<String, String>()

		def utilHostHostnames = tasks.findByPath(':util:hostHostnames')

		def hostHostNames = file(utilHostHostnames.outputFilePath).readLines()

		for (hostHostname in hostHostNames) {
			def parts = hostHostname.split(',')

			def host = parts[0]

			if (parts.size() > 1) {
				def hostname = parts[1]

				hostHostnames.put(host, hostname)
			}
		}

		def hostnamesOwners = new HashMap<String, String>()

		for (hostnameOwner in file("$rootDir/$hostnamesOwnersFilePath")) {
			def parts = hostnameOwner.split(',')

			def hostname = parts[0]

			if (parts.size() > 1) {
				def owner = parts[1]

				hostnamesOwners.put(hostname, owner)
			}
		}

		def ownerHostsVulnerabilities = new HashMap<String, HashMap<String, List<String>>>()

		for (host in hostVulnerabilities.keySet()) {
			def hostname = hostHostnames.get(host)

			def vulnerabilities = hostVulnerabilities.get(host)

			if (hostname == null) {
				def thing = new HashMap<String, List<String>>()

				thing.put(host, vulnerabilities)

				ownerHostsVulnerabilities.put("na", thing)

				continue;
			}

			def owner = hostnamesOwners.get(hostname)

			if (ownerHostsVulnerabilities.containsKey(owner)) {
				def hostnameVulnerabilities = ownerHostsVulnerabilities.get(owner)

				hostnameVulnerabilities.put(hostname, vulnerabilities)
			}
			else {
				def hostnameVulnerabilities = new HashMap<String, List<String>>()

				hostnameVulnerabilities.put(hostname, vulnerabilities)

				if (owner == null) {
					if (ownerHostsVulnerabilities.containsKey('no.owner')) {
						def noOwnerHostNameVulnerabilities = ownerHostsVulnerabilities.get('no.owner')

						noOwnerHostNameVulnerabilities.putAll(hostnameVulnerabilities)
					}
					else {
						ownerHostsVulnerabilities.put('no.owner', hostnameVulnerabilities)
					}
				}
				else {
					ownerHostsVulnerabilities.put(owner, hostnameVulnerabilities)
				}
			}
		}

		def outputFile = file(outputFilePath)

		outputFile.append("screenname\thostname\tvulnerabilities\n")

		for (owner in ownerHostsVulnerabilities.keySet()) {
			for (hostnameVulnerabilities in ownerHostsVulnerabilities.get(owner)) {
				outputFile.append("${owner}\t${hostnameVulnerabilities.key}\t${hostnameVulnerabilities.value.join(', ')}\n")
			}
		}
	}
}